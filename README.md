## Источник:

https://github.com/va-stepanov/vosk-model-ru-adaptation

## Цель

Расширить, адаптировать словарь имеющейся модели для улучшения качества распознавания речи.

## Подготовка

Предполагается, что к моменту обучения у вас уже есть готовая к применению модель.  
Убедимся что модель не распознает контрольное слово. Запишем файл, в котором помимо знакомых для модели слов, фигурируют незнакомые. В моем случае короткие файлы почему то распознавались как пустые, потому я записал голосом минутную цитату из википедии при помощи telegram на android телефоне. Получился ogg файл. При помощи audacity, изменил framerate с 48000 на 8000 и экспортировал его в wav.
Содержание цитаты:  
  
Чо́ботовская улица — улица в районе Ново-Переделкино Западного административного округа города Москвы. Расположена между Боровским шоссе и Лукинской улицей. Нумерация домов ведётся от Боровского шоссе. С нечётной (левой) стороны к Чоботовской примыкает улица Скульптора Мухиной. Улица названа по примыкающему к ней посёлку Чоботы, вошёл в состав Москвы в 1984 году. Для нечётной стороны улицы характерна типовая многоэтажная застройка. Чётная сторона может быть разделена на три части. Ближе к Боровскому шоссе застройка отсутствует. Далее, напротив улицы Скульптора Мухиной, находятся бассейн, каток и теннисный центр. Наконец, ближе к Лукинской улице начинается посёлок Чоботы; его домам присвоена нумерация по Чоботовским аллеям и улицам Новые Сады.  
  
Новое слово - чоботовская. Запустим распознавание, указав путь к аудиофайлу и путь к исходной модели
```
python3 check_model.py test.wav /media/alex/nvme-a/vosk-model-ru-0.10
```
Вывод:  
  
['чем улица улица в районе новопеределкино западного административного округа города москвы расположена между боровским шоссе и латинской улицей нумерация домов ведётся от боровского шоссе', 'с нечётной левой стороны к чем примыкает улица скульптора мухиной', 'улица названа примыкающей к ней посёлку чтобы ты вошёл в состав москвы в тысяча девятьсот восемьдесят четвёртом году', 'для нечётной стороны улицы характерна типовая многоэтажная застройка чётная сторона может быть разделена на три части ближе к городскому шоссе застройка отсутствует далее напротив улице скульптора мухиной находится бассейн каток и теннисный центр наконец ближе к лукьяновской улице начинается посёлок']  
  
Видим, что чоботовская не распознается. А так же не распознались боровского, лукинской, чоботы.
  
Собираем и запускаем контейнер, в котором будут готовиться и добавляться слова
```
git clone https://github.com/format37/vosk-model-ru-adaptation.git
cd vosk-model-ru-adaptation
sudo docker build --file Dockerfile.kaldi-vosk-model-ru --tag alphacep/kaldi-vosk-model-ru:latest .
sudo docker run -d -p 2700:2700 alphacep/kaldi-vosk-model-ru:latest
```
Полученный идентификатор контейнера помещаем в переменную (идентификатор заменить на свой):
```
export VOSKID=a2c164cdba01d0d9a9d33482f2bdfaa6743b40831dbfcd3eedb9febc4b954482
```
## Добавление слов в модель

Подготавливаем corpus.txt, в котором вводим по предложению на строку или слово на строку. Склонять этот стенд сам не умеет. Потому слова чоботовская и чоботовской прописываем отдельно.
Отправляем corpus.txt с хоста на контейрер:
```
sudo docker cp ./corpus.txt $VOSKID:/opt/vosk-model-ru/model/new/data/corpus
```
После отправки файла начнется процесс добавления слов в модель. Следить за ним можно по нагрузке на процессор, или через мониторинг portainer'a. Когда нагрузка резко спадет - модель готова, можно скачивать:

## Копирование модели на хост
(Измените последний параметр на ваш путь, куда будет скопирована модель)
```
sudo docker cp $VOSKID:/opt/vosk-model-ru/model /media/alex/nvme-a/
```
## Проверка новой модели
(Измените последний параметр на ваш путь, куда была скопирована модель)
```
python3 check_model.py test.wav /media/alex/nvme-a/model
```
Вывод:  
  
['чоботовская улица улица в районе ново-переделкино западного административного округа города москвы расположена между боровским шоссе и лукинской улицей нумерация домов ведётся от боровского шоссе', '[unk] левой стороны к чоботовской примыкает улице скульптора мухиной', 'улица названа примыкающей к ней посёлку чоботы вошёл в состав москвы в тысяча девятьсот восемьдесят четвёртом году', 'для нечётной стороны улицы характерны типовая многоэтажная застройка чётная сторона может быть разделена на три части ближе к городскому шоссе застройка отсутствуют далее напротив улице скульптора мужчиной находится бассейн каток и теннисный центр наконец ближе к лукинской улице начинается посёлок [unk]']
  
## Итог
Теперь модель узнает слово чоботовская, а так же прочие слова, которые мы доабвили.  
Появился артефакт [unk].  

Для дообучения вижу два подхода:  
1. Собрать новый corpus.txt содержащий, кроме новых слов, все предыдущие версии corpus
2. Удалить модель в контейнере и загрузить в него последнюю модель с хоста
