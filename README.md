# Ветка в разработке. Не применять.
Данное решение будет падать с ошибкой через некоторое время после нескольких успешных транскрибаций. Причина известна. Исправление в процессе.

## Цель

Расширить, адаптировать словарь имеющейся модели для улучшения качества распознавания речи.

## Подготовка
Требования:   
- [Docker](https://docs.docker.com/engine/install/ubuntu/)

Скачиваем репозиторий:
```
git clone https://github.com/format37/vosk-model-ru-adaptation.git
cd vosk-model-ru-adaptation
```
Прописываем IP своей машины в переменную среды (адрес следует заменить на свой):
```
export VOSK_SERVER_IP=192.168.1.23
```
Запускаем сервис:
```
sh compose.sh
```

## Тестирование перед добавлением слов

Убедимся что модель не распознает контрольное слово. Запишем [файл](https://github.com/format37/vosk-model-ru-adaptation/blob/main/files/test.wav), в котором помимо знакомых для модели слов, фигурируют незнакомые. В моем случае короткие файлы почему то распознавались как пустые, потому я записал голосом минутную цитату из википедии при помощи telegram на android телефоне. Получился ogg файл. При помощи audacity, изменил framerate с 48000 на 8000 и экспортировал его в wav.
Содержание цитаты:  
  
Чо́ботовская улица — улица в районе Ново-Переделкино Западного административного округа города Москвы. Расположена между Боровским шоссе и Лукинской улицей. Нумерация домов ведётся от Боровского шоссе. С нечётной (левой) стороны к Чоботовской примыкает улица Скульптора Мухиной. Улица названа по примыкающему к ней посёлку Чоботы, вошёл в состав Москвы в 1984 году. Для нечётной стороны улицы характерна типовая многоэтажная застройка. Чётная сторона может быть разделена на три части. Ближе к Боровскому шоссе застройка отсутствует. Далее, напротив улицы Скульптора Мухиной, находятся бассейн, каток и теннисный центр. Наконец, ближе к Лукинской улице начинается посёлок Чоботы; его домам присвоена нумерация по Чоботовским аллеям и улицам Новые Сады.  
  
Новое слово - чоботовская. Файл помещаем в папку files/   
Запускаем тест:
```
python3 test.py
```
Вывод:  
  
['те бутовская улица улица в районе новопеределкино западного административного округа города москвы расположена между боровском шоссе и латинской улицей нумерация домов ведётся от боровского шоссе', 'с нечётной левой стороны к чем примыкает улица скульптора мухиной улица названа по примыкающей к ней посёлку чтобы ты вошёл в состав москвы в тысяча девятьсот восемьдесят четвёртом году', 'для нечётной стороны улицы характерна типовая многоэтажная застройка чётная сторона может быть разделена на три части ближе к городскому шоссе застройка отсутствует далее напротив улицы скульптора мухиной находится бассейн каток и теннисный центр наконец ближе к лукьяновской улице начинается посёлок', 'ты его домам присвоено нумерация по чёботах ским аллеям и улицам новые сады']  
  
Видим, что слова 'чоботовская', 'чоботовской', 'лукинской' не распознались.
  
## Добавление слов в модель

Подготавливаем [corpus.txt](https://github.com/format37/vosk-model-ru-adaptation/blob/main/corpus.txt), в котором вводим по предложению на строку или слово на строку. Склонять этот стенд сам не умеет. Потому, слова чоботовская и чоботовской прописываем отдельно.   
Если в вашем случае достаточно часто встречаются определенные фразы, добавление в модель поможет распознавать их более строго, особенно когда запись зашумлена или искажена, даже если отдельные слова фразы модель уже знает.  
Отправляем corpus.txt с хоста в контейнер:
```
sh send_corpus.sh
```
После отправки файла начнется процесс добавления слов в модель. Длится 7 минут, занимает до 10 Гб ОЗУ. После завершения, нагрузка на процессор резко спадет, а в логе сервиса появляется ообщение: INFO:root:Listening on 0.0.0.0:2700   

## Тестирование после добавления слов
Запускаем тест:
```
python3 test.py
```
Вывод:  
['чоботовская улица улица в районе ново-переделкино западного административного округа города москвы расположена между боровский шоссе и лукинской улицей нумерация домов ведётся отбор обского шоссе', '[unk] левой стороны к чоботовская примыкает улице скульптора мухиной', 'улица названа примыкающей к ней посёлку чтобы ты вошёл в состав москвы в тысяча девятьсот восемьдесят четвёртом году', 'для нечётной стороны улицы характерны типовая многоэтажная застройка чётная сторона может быть разделена на три части ближе к боровскому шоссе застройка отсутствуют далее напротив улице скульптора мухиной находится бассейн каток и теннисный центр наконец ближе к лукинской улице начинается посёлок [unk]', 'его домам присвоены нумерация по чоботовской аллеям и улицам новое сады']

## Итог
Теперь модель узнает слово чоботовская, чоботовской, лукинской.  
Иногда появляется артефакт [unk]. Его придется удалять после получения текста.  


## Запуск в прод
Запуск существующего контейнера в режиме демона:
```
sh daemon.sh
```

## Дообучение
Модель забудет добавленные ранее слова после пересоздания сервиса:
```
sh compose.sh
```
Есть два решения:
1. После каждого создания сервиса запускать процесс добавления слов. Это можно автоматизировать, добавив инструкцию копирования актуального corpus.txt в Dockerfile
2. Перед удалением контейнера, скачать обученную сервиса. А при создании, копировать сохраненную ранее модель, прописав соответствующую инструкцию в Dockerfile. Этот метод может сэкономить 7 минут обучения, но уйдет некоторое время на копирование и делать так не пробовал, возможны ошибки.

## Формирование corpus.txt с автоматическим склонением слов
Файлы будем хранить в двух папках:
- Первая содержит файлы, над их словами произведем склонение:
```
corpus_kitchen/data/batch_1/declined
```
- Вторая - файлы, слова из которых склонять которые не будем:
```
corpus_kitchen/data/batch_1/regular
```
Зайдем в corpus_kitchen и скачаем актуальную модель:
```
cd corpus_kitchen/
sh download_model.sh
```
Она понадобится для того, что бы определить, какие слова следует исключить из подготовленного для дообучения набора. Скачивание модели длится около 2 минут.   
Запускаем формирование corpus.txt
```
python3 word_collector.py
```

## Ошибки
```
ASSERTION_FAILED (VoskAPI:Row():cudamatrix/cu-matrix.h:672) Assertion failed: (static_cast<UnsignedMatrixIndexT>(i) < static_cast<UnsignedMatrixIndexT>(num_rows_))
Aborted (core dumped)
```
Следует обновить rnnlm
